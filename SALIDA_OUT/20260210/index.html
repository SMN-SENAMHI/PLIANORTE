<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>PLIA EMAS | 20260210</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
body{margin:0;font-family:Arial;}
.wrap{display:flex;}
#map{width:50%;height:100vh;}
#panel{width:50%;padding:10px;}
canvas{height:350px!important;}
button{margin:5px 0;}
</style>
</head>
<body>
<h2 style="padding:10px">PLIA EMAS | 20260210</h2>
<div class="wrap">
<div id="map"></div>
<div id="panel">
<select id="stationSelect"></select>
<button onclick="resetZoom()">Reset Zoom</button>
<h3>Precipitaci√≥n</h3>
<canvas id="ppChart"></canvas>
<h3>Temperatura</h3>
<canvas id="tChart"></canvas>
</div></div>

<script>
const ESTACIONES=[{"codigo": "472761E6", "nombre": "HUARMACA ", "lat": -5.5659, "lon": -79.5254}, {"codigo": "47E1F02E", "nombre": "TUNEL CHOTANO ", "lat": -6.54049, "lon": -78.78432}, {"codigo": "47201542", "nombre": "TONGORRAPE ", "lat": -6.06692, "lon": -79.68203}, {"codigo": "4724D566", "nombre": "CIRATO ", "lat": -6.65583, "lon": -79.07384}, {"codigo": "472606FA", "nombre": "AYABACA ", "lat": -4.63776, "lon": -79.71077}, {"codigo": "4727F484", "nombre": "CHUGUR ", "lat": -6.66878, "lon": -78.738}, {"codigo": "4727470A", "nombre": "PUENTE CHILETE ", "lat": -7.21968, "lon": -78.83798}, {"codigo": "472FF022", "nombre": "SAPILLICA ", "lat": -4.79639, "lon": -79.99972}, {"codigo": "472F50DA", "nombre": "EL VIRREY ", "lat": -5.53579, "lon": -79.98416}, {"codigo": "472F86B2", "nombre": "CANCHAQUE ", "lat": -5.40055, "lon": -79.6052}, {"codigo": "472FA05E", "nombre": "MALACASI ", "lat": -5.33977, "lon": -79.85794}, {"codigo": "47E94706", "nombre": "HUAMBOS ", "lat": -6.45364, "lon": -78.96319}, {"codigo": "472C92CA", "nombre": "CASCABAMBA ", "lat": -7.38407, "lon": -78.72682}, {"codigo": "472F6540", "nombre": "CHULUCANAS ", "lat": -5.10844, "lon": -80.16954}, {"codigo": "472F7636", "nombre": "MORROPON ", "lat": -5.19465, "lon": -79.97107}, {"codigo": "472FB328", "nombre": "CHALACO ", "lat": -5.03389, "lon": -79.83}, {"codigo": "472FE354", "nombre": "HUANCABAMBA ", "lat": -5.24681, "lon": -79.45399}, {"codigo": "472F00A6", "nombre": "CABO INGA M ", "lat": -3.97594, "lon": -80.40182}, {"codigo": "472F95C4", "nombre": "HACIENDA BIGOTE ", "lat": -5.32089, "lon": -79.78569}, {"codigo": "47E281B0", "nombre": "HUALCUY ", "lat": -4.74701, "lon": -79.60729}, {"codigo": "472FC5B8", "nombre": "PAIMAS ", "lat": -4.63439, "lon": -79.94581}, {"codigo": "47E3055E", "nombre": "CHANCAY BA\u00d1OS ", "lat": -6.57489, "lon": -78.86721}, {"codigo": "472FD6CE", "nombre": "LANCONES ", "lat": -4.6429, "lon": -80.54716}, {"codigo": "472F43AC", "nombre": "HUASIMO ", "lat": -3.99815, "lon": -80.50392}, {"codigo": "4726706A", "nombre": "SAN IGNACIO ", "lat": -5.14422, "lon": -78.99989}, {"codigo": "472680EE", "nombre": "BAMBAMARCA M ", "lat": -6.67981, "lon": -78.52346}, {"codigo": "47269398", "nombre": "JAEN ", "lat": -5.67667, "lon": -78.77418}, {"codigo": "4726A602", "nombre": "CUTERVO ", "lat": -6.37914, "lon": -78.81339}, {"codigo": "4726C3E4", "nombre": "CHOTA ", "lat": -6.55405, "lon": -78.67588}, {"codigo": "472D4658", "nombre": "COSPAN ", "lat": -7.42856, "lon": -78.54106}, {"codigo": "472EA2A4", "nombre": "CASCAS ", "lat": -7.47987, "lon": -78.82367}, {"codigo": "472F13D0", "nombre": "CA\u00d1AVERAL ", "lat": -3.93905, "lon": -80.65055}, {"codigo": "47E35522", "nombre": "LA MUCHALA ", "lat": -6.47998, "lon": -79.22406}, {"codigo": "105130", "nombre": "CHICHILAPAS ", "lat": -5.27948, "lon": -79.30992}, {"codigo": "47E1D6C2", "nombre": "PUENTE SAN CARLOS ", "lat": -6.61515, "lon": -79.27136}, {"codigo": "47E1E358", "nombre": "PUENTE AMBAN ", "lat": -6.58271, "lon": -78.91262}, {"codigo": "47E1C5B4", "nombre": "CA\u00d1AD ", "lat": -6.64934, "lon": -78.99733}, {"codigo": "47E207A4", "nombre": "TONGOD ", "lat": -6.74456, "lon": -78.81392}, {"codigo": "221008", "nombre": "CACAO ", "lat": -5.88406, "lon": -78.96256}, {"codigo": "106140", "nombre": "VISTA FLORIDA ", "lat": -6.72775, "lon": -79.78088}];
const SERIES={};
const BOUNDS=[[-7.47987, -80.65055], [-3.93905, -78.52346]];

const map=L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
map.fitBounds(BOUNDS);

const iconBlue=new L.Icon({
iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
iconSize:[25,41],iconAnchor:[12,41]});
const iconRed=new L.Icon({
iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
iconSize:[25,41],iconAnchor:[12,41]});

let markers={};
let activeMarker=null;

ESTACIONES.forEach(e=>{
 const m=L.marker([e.lat,e.lon],{icon:iconBlue}).addTo(map)
  .bindPopup("<b>"+e.codigo+"</b><br>"+e.nombre);
 m.on("click",()=>selectStation(e.codigo));
 markers[e.codigo]=m;
});

const sel=document.getElementById("stationSelect");
Object.keys(SERIES).forEach(c=>{
 const opt=document.createElement("option");
 opt.value=c; opt.textContent=c;
 sel.appendChild(opt);
});
sel.onchange=()=>selectStation(sel.value);

let chartPP,chartT;

function zoomOptions(){
 return {
  pan:{enabled:true,mode:'x'},
  zoom:{wheel:{enabled:true},drag:{enabled:true},mode:'x',onZoomComplete:syncZoom}
 };
}

function syncZoom({chart}){
 if(!chartPP||!chartT)return;
 const min=chart.scales.x.min;
 const max=chart.scales.x.max;
 if(chart===chartPP){
  chartT.options.scales.x.min=min;
  chartT.options.scales.x.max=max;
  chartT.update("none");
 }else{
  chartPP.options.scales.x.min=min;
  chartPP.options.scales.x.max=max;
  chartPP.update("none");
 }
}

function selectStation(code){
 const s=SERIES[code];
 if(!s)return;

 if(activeMarker)activeMarker.setIcon(iconBlue);
 if(markers[code]){
  markers[code].setIcon(iconRed);
  markers[code].openPopup();
  activeMarker=markers[code];
 }

 drawCharts(s);
}

function drawCharts(s){
 if(chartPP)chartPP.destroy();
 if(chartT)chartT.destroy();

 chartPP=new Chart(ppChart,{
  type:'bar',
  data:{labels:s.fecha,datasets:[
   {label:'OBS',data:s.pp_obs,backgroundColor:'black'},
   {label:'RF',data:s.pp_rf,backgroundColor:'blue'},
   {label:'EQM',data:s.pp_eqm,backgroundColor:'green'},
   {label:'EVT',data:s.pp_evt,backgroundColor:'orange'},
   {label:'WRF',data:s.pp_wrf,backgroundColor:'purple'}
  ]},
  options:{responsive:true,plugins:{zoom:zoomOptions()}}
 });

 chartT=new Chart(tChart,{
  type:'line',
  data:{labels:s.fecha,datasets:[
   {label:'OBS',data:s.t_obs,borderColor:'black'},
   {label:'RF',data:s.t_rf,borderColor:'blue'},
   {label:'EQM',data:s.t_eqm,borderColor:'green'},
   {label:'EVT',data:s.t_evt,borderColor:'orange'},
   {label:'WRF',data:s.t_wrf,borderColor:'purple'}
  ]},
  options:{responsive:true,plugins:{zoom:zoomOptions()}}
 });
}

function resetZoom(){
 if(chartPP)chartPP.resetZoom();
 if(chartT)chartT.resetZoom();
}

if(Object.keys(SERIES).length>0)
 selectStation(Object.keys(SERIES)[0]);
</script>
</body>
</html>
